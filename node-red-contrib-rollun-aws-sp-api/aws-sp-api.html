<script src="../server/openapi-out.js"></script>
<script type="text/javascript">
  function getMethodName(method, path) {
    // console.log(method, path);
    return `${method} ${path}`;
  }

  async function fetchModelsList() {
    if (window.modelsListCache) {
      return window.modelsListCache;
    }

    const result = await fetch('/aws-sp-api/models');
    const json = await result.json();

    if (result.ok) {
      return window.modelsListCache = json.models;
    } else {
      throw new Error('Failed to fetch models list: ' + JSON.stringify(json));
    }
  }

  async function fetchVersion(id, version) {
    if (window.versionCache) {
      return window.versionCache;
    }

    const result = await fetch(`/aws-sp-api/models/${id}/versions/${version}`);
    const json = await result.json();

    if (result.ok) {
      return window.versionCache = json;
    } else {
      throw new Error('Failed to fetch schema: ' + JSON.stringify(json));
    }
  }

  RED.nodes.registerType('rollun-aws-sp-api', {
    category: 'Rollun AWS SP API',
    inputs: 1,
    outputs: 2,
    color: "#bce4d0",
    icon: "aws-sp-api.png",
    paletteLabel: 'AWS SP API',
    defaults: {
      name: {
        value: '',
        required: false,
      },
      credentials: {
        value: '',
        required: true,
        type: 'rollun-aws-sp-api-credentials',
      },
      schema: {
        value: '',
        required: true,
      },
      operation: {
        value: '',
        required: true,
      },
      server: {
        value: 0,
      },
      debug: {
        value: false,
      },
      body: {
        value: 'msg|',
      },
      params: {
        value: 'msg|',
      },
      headers: {
        value: 'msg|',
      },
      query: {
        value: 'msg|',
      },
    },
    label: function () {
      return this.name || this.operation || 'AWS SP API Request';
    },
    labelStyle: function () {
      return this.name ? 'node_label_italic' : '';
    },
    outputLabels: function (index) {
      return [
        'error',
        'success',
      ][index]
    },
    oneditprepare: async function () {
      try {

        const node = this;

        window.utils.makeTypedInput('body', [{ value: "msg", label: "msg." }], undefined, this.body);
        window.utils.makeTypedInput('params', [{ value: "msg", label: "msg." }], undefined, this.params);
        window.utils.makeTypedInput('headers', [{ value: "msg", label: "msg." }], undefined, this.headers);
        window.utils.makeTypedInput('query', [{ value: "msg", label: "msg." }], undefined, this.query);

        const models = await fetchModelsList();

        const flatten = models.map(({id, name, versions}) => 
          versions.map((version) => ({ id, name, ...version })
        )).flat();

        $('#node-input-schema')
          .html(flatten.map(({ id, name, version, title, description }) => {
            const key = `${id}|${version}`;

            const isSelected = key === node.schema;

            if (isSelected) {
              $('#schema-description').html(description || title || '');
            }

            return `<option value="${key}" ${isSelected ? 'selected' : ''}>${name} | ${version}</option>`;
          }).join('\n'));

        if (node.schema) {
          const [schemaId, schemaVersion] = node.schema.split('|');
          const version = await fetchVersion(schemaId, schemaVersion);

          $('#node-input-operation')
            .html(Object.entries(version.paths).map(([path, methods]) => {
              return Object.entries(methods).map(([method, { summary, description }]) => {
                const operation = getMethodName(method, path);
                const isSelected = operation === node.operation;
                
                if (isSelected) {
                  $('#operation-description').html(summary || description || '');
                }

                return `<option value="${operation}" ${isSelected ? 'selected' : ''}>${method.toUpperCase()} ${path}</option>`;
              })
            }).join('\n'));

          const openapiLink = `${window.location.origin}/aws-sp-api/models/${schemaId}/versions/${schemaVersion}`;
          const swaggerEditorLink = `https://swagger-editor.rollun.net/?hideEditor=true&url=${openapiLink}`;
          $('#swagger-ui').html(`
              <div style="width: 100%">
                <a href="${swaggerEditorLink}" style="margin-bottom: 10px; color: cornflowerblue; text-decoration: underline;" target="_blank">Open Swaager UI in new tab</a>
                <div style="width: 100%">
                  <iframe height="700px" width="100%" src="${swaggerEditorLink}"></iframe>
                </div>
              </div>
            `);
        }

 

      // function render(config, url) {
        // $('#node-input-operation')
        //   .html(Object.entries(config.paths).map(([path, methods]) => {
        //     return Object.entries(methods).map(([method, { summary, description }]) => {
        //       const operation = getMethodName(method, path);
        //       const isSelected = operation === node.operation;
        //       return `<option value="${operation}" ${isSelected ? 'selected' : ''}>${method.toUpperCase()} ${path} ${summary || description || ''}</option>`;
        //     })
        //   }).join('\n'));

      //   $('#node-input-server')
      //     .html(config.servers.map(({ url }, idx) => {
      //       const isSelected = idx === +node.server;
      //       return `<option value="${idx}" ${isSelected ? 'selected' : ''}>#${idx + 1} ${url}</option>`;
      //     }).join('\n'));
      //   renderSwaggerUi(url);
      // }

      // if (this.schema) {
      //   const node = RED.nodes.node(this.schema);
      //   render(node.schema, node.schemaUrl);
      // }
      } catch (err) {
          $('#aws-sp-api-errors').html(`
            <div class="ui-state-error">
              <p>
                <span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span>
                <strong>ERROR:</strong>
                <pre>${err.stack}</pre>
              </p>
            </div>
          `);
      }
    },
  });
</script>

<script type="text/x-red" data-template-name="rollun-aws-sp-api">
    <div id="aws-sp-api-errors"></div>
   <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span>Name:</span></label>
        <input type="text" id="node-input-name" />
    </div>
    <div class="form-row" style>
        <label for="node-input-credentials"><i class="fa fa-book"></i> <span>Credentials:</span></label>
        <input type="text" id="node-input-credentials">
    </div>
    <div class="form-row">
        <label for="node-input-schema"><i class="fa fa-tasks"></i> <span>Schema:</span></label>
        <select style="width: 100%" id="node-input-schema"></select>
        <pre id="schema-description"></pre>
    </div>
    <div class="form-row">
        <label for="node-input-operation"><i class="fa fa-tasks"></i> <span>Operation:</span></label>
        <select style="width: 100%" id="node-input-operation"></select>
        <pre id="operation-description"></pre>
    <div class="">
        <span> Debug: log all requests</span>
        <input style="margin-left: 5px; margin-bottom: 6px" type="checkbox" id="node-input-debug">
    </div>
    <h3>Inputs:</h3>
    <div class="form-row" id="body"></div>
    <div class="form-row" id="params"></div>
    <div class="form-row" id="headers"></div>
    <div class="form-row" id="query"></div>
    <div class="form-tips"><b>Tip:</b> If you do not have some of the inputs, leave them empty.</div>
    <div id="swagger-ui"></div>
</script>
